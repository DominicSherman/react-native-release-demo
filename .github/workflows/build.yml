name: Build App
on:
  workflow_dispatch:
    inputs:
      releaseStage:
        type: choice
        description: 'type of release'
        required: true
        default: 'beta'
        options:
          - alpha
          - beta
          - production
      versionChangeType:
        type: choice
        description: 'type of version bump'
        required: true
        default: 'none'
        options:
          - major
          - minor
          - patch
          - none
      platform:
        type: choice
        description: 'platform to build for'
        required: true
        default: 'all'
        options:
          - all
          - ios
          - android
      create-tag:
        type: boolean
        description: 'create a tag for the release in github'
        required: true
        default: true
      branch:
        type: string
        description: 'branch to build'
        required: true
        default: 'main'

jobs:
  build-app:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2

      - name: Setup Git
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Tagging
        id: tagging
        uses: DominicSherman/mobile-release-actions/tagging@v1
        with:
          github-tagging: true
          github-auth-token: ${{ secrets.GITHUB_TOKEN }}
          create-tag: ${{ github.event.inputs.create-tag }}
          branch: ${{ github.event.inputs.branch }}
          version-change-type: ${{ github.event.inputs.versionChangeType }}
          build-version: ${{ github.run_number }}

      - name: Install EAS CLI
        uses: expo/expo-github-action@v7
        with:
          expo-version: 5.x
          eas-version: latest
          token: ${{ secrets.EXPO_CI_TOKEN }}

      - name: Build
        uses: DominicSherman/mobile-release-actions/eas-build@v1
        with:
          platform: ${{ github.event.inputs.platform }}
          expo-profile: ${{ github.event.inputs.releaseStage }}
          auto-submit: ${{ github.event.inputs.releaseStage != 'alpha' }}
      